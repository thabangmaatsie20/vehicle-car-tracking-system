<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ThingSpeak Sensor Dashboard - Channel 3019260</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --ok: #34d399;
      --warn: #fbbf24;
      --bad: #f87171;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(180deg,#0b1224,#0f172a 30%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .header {
      padding: 20px 24px;
      border-bottom: 1px solid #1f2937;
      background: rgba(17,24,39,.6);
      backdrop-filter: blur(6px);
      position: sticky; top: 0; z-index: 10;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0; }
    h2 { font-size: 16px; margin: 0 0 12px; color: var(--muted); font-weight: 600; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
    .card { background: var(--card); border: 1px solid #2a3648; border-radius: 12px; padding: 16px; }

    .metrics { grid-column: span 12; display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .metric { background: #131c2c; border: 1px solid #223046; border-radius: 10px; padding: 14px; display: flex; flex-direction: column; gap: 8px; }
    .metric .label { color: var(--muted); font-size: 12px; letter-spacing: .02em; text-transform: uppercase; }
    .metric .value { font-size: 28px; font-weight: 700; }

    .flex { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .small { font-size: 12px; color: var(--muted); }

    .charts { grid-column: span 12; display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }

    .actions { grid-column: span 12; }
    input, button { border-radius: 8px; border: 1px solid #374151; padding: 10px 12px; background:#0b1220; color:var(--text); }
    input { width: 100%; }
    .form-grid { display: grid; gap: 12px; grid-template-columns: repeat(4, 1fr); }
    .form-actions { display: flex; gap: 12px; align-items: center; }
    button.primary { background: linear-gradient(90deg,#06b6d4,#3b82f6); border: 0; font-weight: 600; cursor: pointer; }
    .status { min-height: 20px; }

    iframe.chart { width: 100%; height: 300px; border: 0; background: #0b1220; border-radius: 10px; }

    @media (max-width: 900px) {
      .metrics { grid-template-columns: repeat(2, 1fr); }
      .charts { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 560px) {
      .metrics { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container flex">
      <div>
        <h1>ThingSpeak Dashboard</h1>
        <div class="small">Channel ID: 3019260 • <a href="https://thingspeak.com/channels/3019260" target="_blank" rel="noopener">Open channel</a></div>
      </div>
      <div class="small">Auto-refreshing every 30s</div>
    </div>
  </div>

  <main class="container">
    <section class="grid">
      <div class="metrics">
        <div class="metric">
          <div class="label">Temperature (Field 1)</div>
          <div class="value" id="tempValue">—</div>
          <div class="small" id="tempTime">Latest: —</div>
        </div>
        <div class="metric">
          <div class="label">Humidity (Field 2)</div>
          <div class="value" id="humValue">—</div>
          <div class="small" id="humTime">Latest: —</div>
        </div>
        <div class="metric">
          <div class="label">Smoke Concentration (Field 3)</div>
          <div class="value" id="smokeValue">—</div>
          <div class="small" id="smokeTime">Latest: —</div>
        </div>
        <div class="metric">
          <div class="label">Flame Intensity (Field 4)</div>
          <div class="value" id="flameValue">—</div>
          <div class="small" id="flameTime">Latest: —</div>
        </div>
      </div>

      <div class="charts">
        <div class="card">
          <h2>Temperature</h2>
          <iframe class="chart" src="https://thingspeak.com/channels/3019260/charts/1?bgcolor=%23121429&color=%23f472b6&dynamic=true&results=60&title=Temperature&xaxis=Time&yaxis=Temp%C2%B0C"></iframe>
        </div>
        <div class="card">
          <h2>Humidity</h2>
          <iframe class="chart" src="https://thingspeak.com/channels/3019260/charts/2?bgcolor=%23121429&color=%234fd1c5&dynamic=true&results=60&title=Humidity&xaxis=Time&yaxis=%25RH"></iframe>
        </div>
        <div class="card">
          <h2>Smoke Concentration</h2>
          <iframe class="chart" src="https://thingspeak.com/channels/3019260/charts/3?bgcolor=%23121429&color=%2363b3ed&dynamic=true&results=60&title=Smoke+Concentration&xaxis=Time&yaxis=ppm"></iframe>
        </div>
        <div class="card">
          <h2>Flame Intensity</h2>
          <iframe class="chart" src="https://thingspeak.com/channels/3019260/charts/4?bgcolor=%23121429&color=%23fbbf24&dynamic=true&results=60&title=Flame+Intensity&xaxis=Time&yaxis=units"></iframe>
        </div>
      </div>

      <div class="card actions">
        <h2>Write Data (uses your write API key)</h2>
        <div class="form-grid">
          <div>
            <label class="small">Temperature (field1)</label>
            <input id="field1Input" type="number" step="any" placeholder="e.g., 24.5" />
          </div>
          <div>
            <label class="small">Humidity (field2)</label>
            <input id="field2Input" type="number" step="any" placeholder="e.g., 60" />
          </div>
          <div>
            <label class="small">Smoke (field3)</label>
            <input id="field3Input" type="number" step="any" placeholder="e.g., 120" />
          </div>
          <div>
            <label class="small">Flame (field4)</label>
            <input id="field4Input" type="number" step="any" placeholder="e.g., 300" />
          </div>
        </div>
        <div class="form-actions" style="margin-top:12px;">
          <button class="primary" id="sendBtn">Send to ThingSpeak</button>
          <div class="status small" id="sendStatus"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const CHANNEL_ID = 3019260;
    const WRITE_API_KEY = "KNIA5RMGNMQUVINO";

    async function fetchLatest() {
      try {
        const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=1`;
        const response = await fetch(url);
        if (!response.ok) throw new Error("Network error");
        const data = await response.json();
        const feed = (data && data.feeds && data.feeds[0]) || null;
        if (!feed) return;

        updateMetric("tempValue", "tempTime", feed.field1, feed.created_at, "°C");
        updateMetric("humValue", "humTime", feed.field2, feed.created_at, "%");
        updateMetric("smokeValue", "smokeTime", feed.field3, feed.created_at, "");
        updateMetric("flameValue", "flameTime", feed.field4, feed.created_at, "");
      } catch (err) {
        console.error(err);
      }
    }

    function updateMetric(valueId, timeId, value, isoTime, unit) {
      const v = (value !== null && value !== undefined) ? value : "—";
      document.getElementById(valueId).textContent = unit ? `${v} ${unit}` : v;
      if (isoTime) {
        const d = new Date(isoTime);
        document.getElementById(timeId).textContent = "Latest: " + d.toLocaleString();
      }
    }

    async function sendUpdate(fields) {
      const params = new URLSearchParams({ api_key: WRITE_API_KEY });
      Object.entries(fields).forEach(([k, v]) => {
        if (v !== "" && v !== null && v !== undefined) params.set(k, v);
      });
      const endpoint = "https://api.thingspeak.com/update.json?" + params.toString();
      const res = await fetch(endpoint, { method: "GET" });
      if (!res.ok) throw new Error("Failed to update");
      const json = await res.json(); // returns entry id or 0
      return json;
    }

    function readInputs() {
      return {
        field1: document.getElementById("field1Input").value.trim(),
        field2: document.getElementById("field2Input").value.trim(),
        field3: document.getElementById("field3Input").value.trim(),
        field4: document.getElementById("field4Input").value.trim(),
      };
    }

    function setStatus(text, type) {
      const el = document.getElementById("sendStatus");
      el.textContent = text;
      el.style.color = type === "error" ? "#f87171" : type === "ok" ? "#34d399" : "#9ca3af";
    }

    document.getElementById("sendBtn").addEventListener("click", async () => {
      setStatus("Sending...", "info");
      try {
        const fields = readInputs();
        const result = await sendUpdate(fields);
        if (result === 0) {
          setStatus("Update accepted but throttled; try again later.", "error");
        } else {
          setStatus("Update successful. Entry ID: " + result, "ok");
          setTimeout(fetchLatest, 2000);
        }
      } catch (e) {
        setStatus("Failed to send: " + e.message, "error");
      }
    });

    fetchLatest();
    setInterval(fetchLatest, 30000);
  </script>
</body>
</html>
