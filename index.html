<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vehicle Security Dashboard</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
      :root {
        --bg-dark: #0e0f12;
        --card-dark: #151821;
        --text-muted: #a0a6b2;
        --success: #20c997;
        --danger: #ff5c77;
        --warning: #f7b84b;
      }
      body {
        background: radial-gradient(1200px 800px at 10% -10%, #141824, transparent),
          radial-gradient(1200px 800px at 90% 110%, #141824, transparent), var(--bg-dark);
        color: #e6e6e6;
        min-height: 100vh;
      }
      .navbar-brand span {
        color: #8ab4ff;
      }
      .card {
        background-color: var(--card-dark);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .card-header {
        background-color: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .map-container {
        height: 460px;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }
      #map {
        height: 100%;
        width: 100%;
      }
      .table thead th {
        color: #c9cdd6;
      }
      .table > :not(caption) > * > * {
        background-color: transparent !important;
        border-bottom-color: rgba(255, 255, 255, 0.08);
      }
      .table-danger {
        background-color: rgba(255, 92, 119, 0.12) !important;
      }
      .status-badge {
        font-weight: 600;
        letter-spacing: 0.3px;
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
      }
      .status-success { color: var(--success); background-color: rgba(32, 201, 151, 0.12); }
      .status-danger { color: var(--danger); background-color: rgba(255, 92, 119, 0.12); }
      .status-warning { color: var(--warning); background-color: rgba(247, 184, 75, 0.12); }

      .spinner-wrap {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-muted);
      }

      .small-muted { color: var(--text-muted); font-size: 0.9rem; }
      .xsmall-muted { color: var(--text-muted); font-size: 0.8rem; }

      @media (max-width: 576px) {
        .map-container { height: 360px; }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg border-bottom" style="background: rgba(20,24,36,0.7); backdrop-filter: blur(8px);">
      <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="#">
          <i class="bi bi-shield-lock me-2"></i>
          Vehicle Security <span>Dashboard</span>
        </a>
        <div class="d-flex align-items-center gap-3 ms-auto">
          <div class="xsmall-muted" id="lastUpdateGlobal">Last update: —</div>
          <button id="refreshBtn" class="btn btn-sm btn-outline-light">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
          </button>
        </div>
      </div>
    </nav>

    <main class="container-fluid py-3 py-md-4">
      <!-- Map Row -->
      <div class="row g-3 g-md-4">
        <div class="col-12">
          <div class="map-container position-relative">
            <div id="map"></div>
            <div id="mapSpinner" class="position-absolute top-0 end-0 m-2 spinner-wrap">
              <div class="spinner-border spinner-border-sm text-light" role="status"></div>
              <span class="xsmall-muted">Loading map...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Cards Row -->
      <div class="row g-3 g-md-4 mt-1">
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between py-2">
              <div class="fw-semibold"><i class="bi bi-unlock me-2"></i>Access Status</div>
              <span id="accessStatusBadge" class="status-badge status-warning">Checking...</span>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center gap-3">
                <div id="accessIcon" class="display-6"><i class="bi bi-hourglass-split text-warning"></i></div>
                <div>
                  <div id="accessStatusText" class="fs-5">—</div>
                  <div class="xsmall-muted" id="vehicleOnlineText">Status: Unknown</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between py-2">
              <div class="fw-semibold"><i class="bi bi-exclamation-triangle me-2"></i>Intrusion Monitor</div>
              <span id="intruderBadge" class="status-badge status-warning">Monitoring...</span>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center gap-3">
                <div class="display-6" id="intruderIcon"><i class="bi bi-bell text-warning"></i></div>
                <div>
                  <div id="intruderText" class="fs-5">No recent data</div>
                  <div class="xsmall-muted" id="intruderMeta">—</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between py-2">
              <div class="fw-semibold"><i class="bi bi-geo-alt me-2"></i>Location</div>
              <span id="locationBadge" class="status-badge status-warning">Waiting GPS...</span>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-6">
                  <div class="xsmall-muted">Latitude</div>
                  <div id="latValue" class="fs-6">—</div>
                </div>
                <div class="col-6">
                  <div class="xsmall-muted">Longitude</div>
                  <div id="lngValue" class="fs-6">—</div>
                </div>
              </div>
              <div class="mt-2 xsmall-muted" id="gpsMeta">GPS: Initializing</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts and Log Row -->
      <div class="row g-3 g-md-4 mt-1">
        <div class="col-12 col-xl-6">
          <div class="card h-100">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
              <div class="fw-semibold"><i class="bi bi-graph-up-arrow me-2"></i>Location History (Last 10)</div>
              <div id="chartSpinner" class="spinner-wrap">
                <div class="spinner-border spinner-border-sm text-light" role="status"></div>
                <span class="xsmall-muted">Loading...</span>
              </div>
            </div>
            <div class="card-body">
              <canvas id="lineChart" height="150"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-6">
          <div class="card h-100">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
              <div class="fw-semibold"><i class="bi bi-pie-chart me-2"></i>Access Stats (Last Hour)</div>
              <div id="pieSpinner" class="spinner-wrap">
                <div class="spinner-border spinner-border-sm text-light" role="status"></div>
                <span class="xsmall-muted">Loading...</span>
              </div>
            </div>
            <div class="card-body">
              <canvas id="pieChart" height="150"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 g-md-4 mt-1">
        <div class="col-12">
          <div class="card">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
              <div class="fw-semibold"><i class="bi bi-list-check me-2"></i>Event Log (Last 20)</div>
              <div id="logSpinner" class="spinner-wrap">
                <div class="spinner-border spinner-border-sm text-light" role="status"></div>
                <span class="xsmall-muted">Loading...</span>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive" style="max-height: 320px;">
                <table class="table table-hover table-sm align-middle mb-0">
                  <thead class="sticky-top" style="background: rgba(255,255,255,0.02);">
                    <tr>
                      <th style="width: 22%;">Timestamp</th>
                      <th style="width: 18%;">Latitude</th>
                      <th style="width: 18%;">Longitude</th>
                      <th style="width: 14%;">Access</th>
                      <th style="width: 28%;">Notes</th>
                    </tr>
                  </thead>
                  <tbody id="eventLogBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Vendor Scripts -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
      // ===============================
      // CONFIGURATION
      // ===============================
      // Replace with your ThingSpeak channel details or supply via URL params (?channelId=...&apiKey=...)
      const DEFAULT_CHANNEL_ID = '1234567'; // Example Channel ID
      const DEFAULT_READ_API_KEY = 'ABCDEFGHIJKLMNOP'; // Example Read API Key (public/read-only)

      // Polling interval in milliseconds
      const POLL_INTERVAL_MS = 15000; // 15 seconds

      // Map defaults (centered broadly on South Africa)
      const MAP_INITIAL_CENTER = { lat: -30, lng: 25 };
      const MAP_INITIAL_ZOOM = 5;

      // Enable simple demo mode by appending ?demo=1 to the URL (uses synthetic data if API fails)
      const urlParams = new URLSearchParams(window.location.search);
      const DEMO_MODE = urlParams.get('demo') === '1';
      const CHANNEL_ID = urlParams.get('channelId') || DEFAULT_CHANNEL_ID;
      const READ_API_KEY = urlParams.get('apiKey') || DEFAULT_READ_API_KEY;

      // ===============================
      // UTILITIES
      // ===============================
      function parseNumber(value) {
        if (value === null || value === undefined) return null;
        const n = Number(value);
        return Number.isFinite(n) ? n : null;
      }

      function formatDate(d) {
        try {
          const date = d instanceof Date ? d : new Date(d);
          if (Number.isNaN(date.getTime())) return 'Invalid date';
          return date.toLocaleString(undefined, {
            year: 'numeric', month: 'short', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
        } catch (e) { return '—'; }
      }

      function byLatestAscending(a, b) {
        return new Date(a.created_at) - new Date(b.created_at);
      }

      function byLatestDescending(a, b) {
        return new Date(b.created_at) - new Date(a.created_at);
      }

      function setText(el, text) {
        if (!el) return;
        el.textContent = text;
      }

      function show(el) { if (el) el.classList.remove('d-none'); }
      function hide(el) { if (el) el.classList.add('d-none'); }

      function setBadge(el, text, type) {
        if (!el) return;
        el.className = 'status-badge ' + (type === 'success' ? 'status-success' : type === 'danger' ? 'status-danger' : 'status-warning');
        el.textContent = text;
      }

      function createNote(text, colorClass) {
        return `<span class="badge ${colorClass}" style="font-weight:500;">${text}</span>`;
      }

      // ===============================
      // THINGSPEAK API
      // ===============================
      const TS_BASE = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json`;
      async function fetchFeeds(params) {
        const u = new URL(TS_BASE);
        // Append API key even for public channel; harmless if not required
        u.searchParams.set('api_key', READ_API_KEY);
        Object.entries(params || {}).forEach(([k, v]) => u.searchParams.set(k, v));
        const res = await fetch(u.toString(), { cache: 'no-store' });
        if (!res.ok) throw new Error(`ThingSpeak error: ${res.status}`);
        const data = await res.json();
        if (!data || !Array.isArray(data.feeds)) return { channel: data?.channel, feeds: [] };
        return data;
      }

      function synthesizeDemoFeeds(count, minutesSpan = 30) {
        // Generates synthetic feeds around Johannesburg for demo/testing
        const now = Date.now();
        const feeds = [];
        let lat = -26.2041;
        let lng = 28.0473;
        for (let i = count - 1; i >= 0; i--) {
          const t = new Date(now - (i * (minutesSpan * 60 * 1000) / count));
          lat += (Math.random() - 0.5) * 0.01;
          lng += (Math.random() - 0.5) * 0.01;
          const unauthorized = Math.random() < 0.15 ? 1 : 0;
          const granted = unauthorized ? 0 : (Math.random() < 0.85 ? 1 : 0);
          feeds.push({
            created_at: t.toISOString(),
            entry_id: i + 1,
            field1: lat.toFixed(6),
            field2: lng.toFixed(6),
            field3: unauthorized.toString(),
            field4: granted.toString()
          });
        }
        return { channel: { id: Number(CHANNEL_ID) }, feeds };
      }

      // ===============================
      // MAP INIT
      // ===============================
      let map, vehicleMarker, lastValidPosition = null;
      function initMap() {
        map = L.map('map', {
          center: [MAP_INITIAL_CENTER.lat, MAP_INITIAL_CENTER.lng],
          zoom: MAP_INITIAL_ZOOM,
          zoomControl: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        vehicleMarker = L.marker([MAP_INITIAL_CENTER.lat, MAP_INITIAL_CENTER.lng], {
          title: 'Vehicle Location'
        }).addTo(map);
        vehicleMarker.bindPopup('Location Unavailable');

        const mapSpinner = document.getElementById('mapSpinner');
        hide(mapSpinner);
      }

      // ===============================
      // CHARTS INIT
      // ===============================
      let lineChart, pieChart;
      function initCharts() {
        const lineCtx = document.getElementById('lineChart').getContext('2d');
        lineChart = new Chart(lineCtx, {
          type: 'line',
          data: { labels: [], datasets: [
            {
              label: 'Latitude', data: [], borderColor: '#8ab4ff', backgroundColor: 'rgba(138,180,255,0.15)', tension: 0.3, pointRadius: 2
            },
            {
              label: 'Longitude', data: [], borderColor: '#f7b84b', backgroundColor: 'rgba(247,184,75,0.15)', tension: 0.3, pointRadius: 2
            }
          ]},
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { ticks: { color: '#9aa2af' }, grid: { color: 'rgba(255,255,255,0.06)' } },
              y: { ticks: { color: '#9aa2af' }, grid: { color: 'rgba(255,255,255,0.06)' } }
            },
            plugins: {
              legend: { labels: { color: '#c9cdd6' } },
              tooltip: { intersect: false, mode: 'index' }
            }
          }
        });

        const pieCtx = document.getElementById('pieChart').getContext('2d');
        pieChart = new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: ['Authorized', 'Unauthorized'],
            datasets: [{ data: [0, 0], backgroundColor: ['rgba(32,201,151,0.6)', 'rgba(255,92,119,0.6)'], borderColor: ['#20c997', '#ff5c77'] }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#c9cdd6' } }
            }
          }
        });

        hide(document.getElementById('chartSpinner'));
        hide(document.getElementById('pieSpinner'));
      }

      // ===============================
      // UI UPDATE FUNCTIONS
      // ===============================
      function updateMapAndLocation(feedsSortedDesc) {
        if (!feedsSortedDesc || feedsSortedDesc.length === 0) {
          vehicleMarker.setPopupContent('Vehicle Offline');
          vehicleMarker.openPopup();
          setBadge(document.getElementById('locationBadge'), 'Vehicle Offline', 'danger');
          setText(document.getElementById('gpsMeta'), 'No recent data');
          return;
        }
        const latest = feedsSortedDesc[0];
        const lat = parseNumber(latest.field1);
        const lng = parseNumber(latest.field2);
        if (lat !== null && lng !== null) {
          lastValidPosition = { lat, lng };
          vehicleMarker.setLatLng([lat, lng]);
          vehicleMarker.setPopupContent(`Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}<br/><span class="xsmall-muted">Updated: ${formatDate(latest.created_at)}</span>`);
          setBadge(document.getElementById('locationBadge'), 'GPS Locked', 'success');
          setText(document.getElementById('latValue'), lat.toFixed(6));
          setText(document.getElementById('lngValue'), lng.toFixed(6));
          setText(document.getElementById('gpsMeta'), `Last fix: ${formatDate(latest.created_at)}`);
        } else {
          setBadge(document.getElementById('locationBadge'), 'Location Unavailable', 'warning');
          setText(document.getElementById('latValue'), '—');
          setText(document.getElementById('lngValue'), '—');
          setText(document.getElementById('gpsMeta'), `Updated: ${formatDate(latest.created_at)}`);
          if (lastValidPosition) {
            vehicleMarker.setLatLng([lastValidPosition.lat, lastValidPosition.lng]);
            vehicleMarker.setPopupContent('Last known position');
          } else {
            vehicleMarker.setLatLng([MAP_INITIAL_CENTER.lat, MAP_INITIAL_CENTER.lng]);
            vehicleMarker.setPopupContent('Location Unavailable');
          }
        }
      }

      function updateAccessStatus(latest, last10FeedsDesc) {
        const accessBadge = document.getElementById('accessStatusBadge');
        const accessIcon = document.getElementById('accessIcon');
        const accessText = document.getElementById('accessStatusText');
        const onlineText = document.getElementById('vehicleOnlineText');

        if (!latest) {
          setBadge(accessBadge, 'Offline', 'danger');
          accessIcon.innerHTML = '<i class="bi bi-x-octagon text-danger"></i>';
          setText(accessText, 'Vehicle Offline');
          setText(onlineText, 'No recent data');
          return;
        }

        const granted = latest.field4 === '1' || latest.field4 === 1;
        const unauthorized = latest.field3 === '1' || latest.field3 === 1;
        if (granted) {
          setBadge(accessBadge, 'Authorized', 'success');
          accessIcon.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
          setText(accessText, 'Access Granted');
          setText(onlineText, `Updated: ${formatDate(latest.created_at)}`);
        } else {
          setBadge(accessBadge, 'Unauthorized', 'danger');
          accessIcon.innerHTML = '<i class="bi bi-shield-exclamation text-danger"></i>';
          setText(accessText, 'Access Denied');
          setText(onlineText, `Updated: ${formatDate(latest.created_at)}`);
        }

        // Intruder panel uses last 10 entries
        const intruderBadge = document.getElementById('intruderBadge');
        const intruderIcon = document.getElementById('intruderIcon');
        const intruderText = document.getElementById('intruderText');
        const intruderMeta = document.getElementById('intruderMeta');

        const alerts = (last10FeedsDesc || []).filter(f => f.field3 === '1' || f.field3 === 1);
        const lastAlert = alerts[0];
        const alertCount = alerts.length;
        if (alertCount > 0) {
          setBadge(intruderBadge, 'Intruder Alert', 'danger');
          intruderIcon.innerHTML = '<i class="bi bi-alarm-fill text-danger"></i>';
          setText(intruderText, 'Intruder Alert!');
          setText(intruderMeta, `Recent alerts (last 10): ${alertCount}${lastAlert ? ' • Last: ' + formatDate(lastAlert.created_at) : ''}`);
        } else {
          setBadge(intruderBadge, 'Clear', 'success');
          intruderIcon.innerHTML = '<i class="bi bi-bell-slash-fill text-success"></i>';
          setText(intruderText, 'No Intrusions Detected');
          setText(intruderMeta, `Checked: ${formatDate(latest.created_at)}`);
        }
      }

      function updateEventLog(feedsDesc) {
        const tbody = document.getElementById('eventLogBody');
        tbody.innerHTML = '';
        if (!feedsDesc || feedsDesc.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center small-muted">No recent data. Vehicle Offline.</td></tr>';
          return;
        }
        feedsDesc.forEach(feed => {
          const lat = parseNumber(feed.field1);
          const lng = parseNumber(feed.field2);
          const unauthorized = feed.field3 === '1' || feed.field3 === 1;
          const granted = feed.field4 === '1' || feed.field4 === 1;
          const tr = document.createElement('tr');
          if (unauthorized || !granted) tr.classList.add('table-danger');
          tr.innerHTML = `
            <td class="xsmall-muted">${formatDate(feed.created_at)}</td>
            <td>${lat !== null ? lat.toFixed(6) : '—'}</td>
            <td>${lng !== null ? lng.toFixed(6) : '—'}</td>
            <td>${granted ? createNote('Authorized', 'text-bg-success') : createNote('Denied', 'text-bg-danger')}</td>
            <td>${unauthorized ? createNote('Intruder', 'text-bg-danger') : createNote('Normal', 'text-bg-secondary')}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function updateLineChart(last10Asc) {
        const labels = last10Asc.map(f => new Date(f.created_at)).map(formatDate);
        const latSeries = last10Asc.map(f => parseNumber(f.field1));
        const lngSeries = last10Asc.map(f => parseNumber(f.field2));
        lineChart.data.labels = labels;
        lineChart.data.datasets[0].data = latSeries;
        lineChart.data.datasets[1].data = lngSeries;
        lineChart.update();
      }

      function updatePieChartFromFeeds(feedsDesc) {
        const grantedCount = feedsDesc.filter(f => f.field4 === '1' || f.field4 === 1).length;
        const deniedCount = feedsDesc.length - grantedCount;
        pieChart.data.datasets[0].data = [grantedCount, deniedCount];
        pieChart.update();
      }

      // ===============================
      // DATA LOAD + POLLING
      // ===============================
      let pollTimer = null;
      async function loadAll() {
        // Show local spinners during refresh
        show(document.getElementById('mapSpinner'));
        show(document.getElementById('chartSpinner'));
        show(document.getElementById('pieSpinner'));
        show(document.getElementById('logSpinner'));

        try {
          // Fetch last 20 entries for map, status, line chart, and log
          let data20;
          try {
            data20 = await fetchFeeds({ results: '20' });
          } catch (e) {
            if (DEMO_MODE) {
              data20 = synthesizeDemoFeeds(20);
            } else {
              throw e;
            }
          }

          const feeds20 = (data20.feeds || []).slice();
          feeds20.sort(byLatestDescending);

          const latest = feeds20[0];
          // Update global last update text
          setText(document.getElementById('lastUpdateGlobal'), 'Last update: ' + (latest ? formatDate(latest.created_at) : '—'));

          // Map + location panel
          updateMapAndLocation(feeds20);

          // Access + intruder status using last 10
          const last10Desc = feeds20.slice(0, 10);
          updateAccessStatus(latest, last10Desc);

          // Event log (last 20, newest first)
          updateEventLog(feeds20);

          // Line chart uses last 10 ascending time order
          const last10Asc = last10Desc.slice().sort(byLatestAscending);
          updateLineChart(last10Asc);

          // Fetch last hour for pie chart
          let dataHour;
          try {
            // Use minutes param to fetch last 60 minutes; cap results to avoid huge payload
            dataHour = await fetchFeeds({ minutes: '60', results: '200' });
          } catch (e) {
            if (DEMO_MODE) {
              dataHour = synthesizeDemoFeeds(50, 60);
            } else {
              throw e;
            }
          }
          const feedsHour = (dataHour.feeds || []).slice().sort(byLatestDescending);
          updatePieChartFromFeeds(feedsHour);

        } catch (err) {
          console.error(err);
          // Surface user-friendly messages
          setText(document.getElementById('lastUpdateGlobal'), 'Last update: error');
          setBadge(document.getElementById('accessStatusBadge'), 'Error', 'danger');
          document.getElementById('accessIcon').innerHTML = '<i class="bi bi-bug text-danger"></i>';
          setText(document.getElementById('accessStatusText'), 'Unable to fetch data');
          setText(document.getElementById('vehicleOnlineText'), err.message || 'Network error');
          setBadge(document.getElementById('intruderBadge'), 'Unknown', 'warning');
          document.getElementById('intruderIcon').innerHTML = '<i class="bi bi-bell text-warning"></i>';
          setText(document.getElementById('intruderText'), 'Unknown');
          setText(document.getElementById('intruderMeta'), 'No data');
          setBadge(document.getElementById('locationBadge'), 'Unknown', 'warning');
          setText(document.getElementById('gpsMeta'), '—');
          updateEventLog([]);
          if (lineChart) {
            lineChart.data.labels = [];
            lineChart.data.datasets[0].data = [];
            lineChart.data.datasets[1].data = [];
            lineChart.update();
          }
          if (pieChart) {
            pieChart.data.datasets[0].data = [0, 0];
            pieChart.update();
          }
        } finally {
          hide(document.getElementById('mapSpinner'));
          hide(document.getElementById('chartSpinner'));
          hide(document.getElementById('pieSpinner'));
          hide(document.getElementById('logSpinner'));
        }
      }

      function startPolling() {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(loadAll, POLL_INTERVAL_MS);
      }

      // ===============================
      // BOOTSTRAP APP
      // ===============================
      window.addEventListener('DOMContentLoaded', () => {
        initMap();
        initCharts();
        loadAll().then(startPolling);
        document.getElementById('refreshBtn').addEventListener('click', () => {
          loadAll();
        });
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vehicle Security IoT Dashboard</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      html, body {
        height: 100%;
        background-color: #0b0d10;
      }
      .navbar-brand {
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      #map {
        width: 100%;
        height: 52vh;
        border-radius: 0.5rem;
        overflow: hidden;
      }
      @media (max-width: 576px) {
        #map { height: 46vh; }
      }
      .card {
        background-color: #101319;
        border: 1px solid rgba(255,255,255,0.06);
      }
      .table thead th {
        position: sticky;
        top: 0;
        background-color: #121622;
        z-index: 1;
      }
      .table-responsive {
        max-height: 280px;
      }
      .row-compact { row-gap: 1rem; }
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
      }
      .status-badge .bi { font-size: 1.1rem; }
      .overlay-center {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.35);
        color: #cfd8dc;
        z-index: 400;
        text-align: center;
      }
      .small-muted { color: #94a3b8; font-size: 0.9rem; }
      .section-title { font-weight: 600; }
      .map-wrapper { position: relative; }
      .spinner-border-sm { --bs-spinner-width: 1rem; --bs-spinner-height: 1rem; }
      .badge-soft {
        background-color: rgba(255,255,255,0.06);
        color: #cbd5e1;
      }
      .table-hover tbody tr:hover { background-color: rgba(255,255,255,0.03); }
      .text-green { color: #22c55e !important; }
      .text-red { color: #ef4444 !important; }
      .border-top-subtle { border-top: 1px solid rgba(255,255,255,0.08); }
    </style>
  </head>
  <body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary-subtle">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Vehicle Security Dashboard</a>
        <div class="d-flex align-items-center gap-3 ms-auto">
          <span id="lastUpdate" class="small text-secondary">Last update: —</span>
          <button id="refreshBtn" class="btn btn-outline-light btn-sm">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
          </button>
        </div>
      </div>
    </nav>

    <main class="container-fluid py-3">
      <!-- Map Section -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-body p-2 p-sm-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="section-title mb-0">Map View</h6>
                <span id="connectionStatus" class="badge badge-soft">Connecting…</span>
              </div>
              <div class="map-wrapper">
                <div id="map"></div>
                <div id="mapOverlay" class="overlay-center" style="display:none;">
                  <div>
                    <div class="spinner-border text-light mb-3" role="status"></div>
                    <div id="mapOverlayText">Loading data…</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Cards -->
      <div class="row row-compact mb-3">
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="section-title mb-1">Access Status</h6>
                  <div class="small-muted">Based on latest entry (Field 4)</div>
                </div>
                <span id="vehicleOnlineBadge" class="badge badge-soft">Status: Unknown</span>
              </div>
              <div id="accessStatus" class="d-flex align-items-center gap-2 fs-5">
                <span class="text-secondary"><i class="bi bi-shield-lock"></i></span>
                <span>Waiting for data…</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="section-title mb-1">Intruder Alerts</h6>
                  <div class="small-muted">Field 3 over last 10 entries</div>
                </div>
                <span id="alertCountBadge" class="badge text-bg-danger" style="display:none;">0 Alerts</span>
              </div>
              <div id="intruderPanel" class="d-flex align-items-center gap-2 fs-5">
                <span class="text-secondary"><i class="bi bi-bell"></i></span>
                <span>No alerts detected.</span>
              </div>
              <div id="lastAlertTime" class="small text-secondary mt-2" style="display:none;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row row-compact mb-3">
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="section-title mb-0">Location History (Last 10)</h6>
                <span class="small-muted">Latitude and Longitude over time</span>
              </div>
              <canvas id="lineChart" height="160"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="section-title mb-0">Access Stats (Last Hour)</h6>
                <span class="small-muted">Authorized vs Unauthorized</span>
              </div>
              <canvas id="pieChart" height="160"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Event Log -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="section-title mb-0">Event Log (Last 20 Entries)</h6>
                <span class="small-muted">Newest at top</span>
              </div>
              <div class="table-responsive border-top-subtle">
                <table class="table table-sm table-hover align-middle mb-0" id="eventTable">
                  <thead>
                    <tr>
                      <th style="width: 26%;">Timestamp</th>
                      <th style="width: 18%;">Latitude</th>
                      <th style="width: 18%;">Longitude</th>
                      <th style="width: 18%;">Access</th>
                      <th style="width: 20%;">Alert</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="container-fluid pb-4">
      <div class="text-center text-secondary small">
        Map data © <a href="https://www.openstreetmap.org/" target="_blank" rel="noopener noreferrer">OpenStreetMap</a> contributors • Tiles © <a href="https://carto.com/" target="_blank" rel="noopener noreferrer">CARTO</a>
      </div>
    </footer>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      // ======== Configuration ========
      // You can customize via URL query params: ?channel=1234567&readKey=ABCDEFGHIJKLMNOP
      const DEFAULT_CHANNEL_ID = 1234567; // Example Channel ID (replace for production)
      const DEFAULT_READ_API_KEY = "ABCDEFGHIJKLMNOP"; // Example Read Key (replace for production)
      const API_POLL_INTERVAL_MS = 15000; // 15 seconds
      const INITIAL_MAP_CENTER = { lat: -30, lng: 25 }; // South Africa
      const OFFLINE_THRESHOLD_MINUTES = 5; // consider offline if no update within this

      // ======== Helpers ========
      const qs = new URLSearchParams(window.location.search);
      const CHANNEL_ID = Number(qs.get('channel')) || DEFAULT_CHANNEL_ID;
      const READ_API_KEY = (qs.get('readKey') || DEFAULT_READ_API_KEY).trim();

      function thingspeakFeedsUrl(results = 100) {
        const base = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json`;
        const params = new URLSearchParams({ api_key: READ_API_KEY, results: String(results) });
        return `${base}?${params.toString()}`;
      }

      function parseNumber(value) {
        const n = Number(value);
        return Number.isFinite(n) ? n : null;
      }

      function formatTimestamp(ts) {
        if (!ts) return '—';
        try {
          const d = new Date(ts);
          if (isNaN(d.getTime())) return ts;
          return d.toLocaleString();
        } catch { return ts; }
      }

      function minutesSince(ts) {
        const d = new Date(ts);
        if (isNaN(d.getTime())) return Infinity;
        return (Date.now() - d.getTime()) / 60000;
      }

      function isValidLatLng(lat, lng) {
        return lat !== null && lng !== null && lat <= 90 && lat >= -90 && lng <= 180 && lng >= -180;
      }

      // ======== State ========
      let leafletMap = null;
      let vehicleMarker = null;
      let mapInitialized = false;
      let lineChart = null;
      let pieChart = null;
      let firstLoad = true;
      let lastKnownCoords = null;

      // ======== UI Elements ========
      const els = {};
      function cacheEls() {
        els.map = document.getElementById('map');
        els.mapOverlay = document.getElementById('mapOverlay');
        els.mapOverlayText = document.getElementById('mapOverlayText');
        els.connectionStatus = document.getElementById('connectionStatus');
        els.lastUpdate = document.getElementById('lastUpdate');
        els.refreshBtn = document.getElementById('refreshBtn');
        els.accessStatus = document.getElementById('accessStatus');
        els.vehicleOnlineBadge = document.getElementById('vehicleOnlineBadge');
        els.intruderPanel = document.getElementById('intruderPanel');
        els.alertCountBadge = document.getElementById('alertCountBadge');
        els.lastAlertTime = document.getElementById('lastAlertTime');
        els.eventTableBody = document.querySelector('#eventTable tbody');
        els.lineChart = document.getElementById('lineChart');
        els.pieChart = document.getElementById('pieChart');
      }

      // ======== Map ========
      function initMap() {
        leafletMap = L.map('map', {
          center: [INITIAL_MAP_CENTER.lat, INITIAL_MAP_CENTER.lng],
          zoom: 5,
          zoomControl: true
        });
        // Dark tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 19
        }).addTo(leafletMap);
        mapInitialized = true;
      }

      function updateMap(lat, lng, label) {
        if (!mapInitialized) return;
        if (!isValidLatLng(lat, lng)) {
          // Show overlay indicating location unavailable
          els.mapOverlayText.textContent = 'Location Unavailable';
          els.mapOverlay.style.display = 'flex';
          return;
        }
        els.mapOverlay.style.display = 'none';

        const latLng = [lat, lng];
        if (!vehicleMarker) {
          vehicleMarker = L.marker(latLng).addTo(leafletMap);
          leafletMap.setView(latLng, 12);
        } else {
          vehicleMarker.setLatLng(latLng);
          // Smooth pan without changing zoom if movement is significant
          const panIfFar = !lastKnownCoords || Math.abs(lastKnownCoords.lat - lat) > 0.01 || Math.abs(lastKnownCoords.lng - lng) > 0.01;
          if (panIfFar) {
            leafletMap.panTo(latLng, { animate: true, duration: 0.8 });
          }
        }
        lastKnownCoords = { lat, lng };

        const popupHtml = `<div><strong>Vehicle Location</strong><br/>Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}<br/><span class="text-secondary">${label}</span></div>`;
        vehicleMarker.bindPopup(popupHtml);
      }

      // ======== Charts ========
      function initCharts() {
        // Line chart with two datasets (lat, lng)
        lineChart = new Chart(els.lineChart, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'Latitude',
                data: [],
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96,165,250,0.15)',
                tension: 0.3,
                pointRadius: 2
              },
              {
                label: 'Longitude',
                data: [],
                borderColor: '#f472b6',
                backgroundColor: 'rgba(244,114,182,0.15)',
                tension: 0.3,
                pointRadius: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { ticks: { color: '#94a3b8' } },
              y: { ticks: { color: '#94a3b8' } }
            },
            plugins: {
              legend: { labels: { color: '#cbd5e1' } }
            }
          }
        });

        // Pie chart for access stats
        pieChart = new Chart(els.pieChart, {
          type: 'pie',
          data: {
            labels: ['Authorized', 'Unauthorized'],
            datasets: [
              {
                label: 'Access',
                data: [0, 0],
                backgroundColor: ['#22c55e', '#ef4444']
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#cbd5e1' } }
            }
          }
        });
      }

      function updateLineChart(points) {
        // points: array of { t: string, lat: number|null, lng: number|null }
        const labels = points.map(p => new Date(p.t)).map(d => d.toLocaleTimeString());
        const latSeries = points.map(p => p.lat);
        const lngSeries = points.map(p => p.lng);
        lineChart.data.labels = labels;
        lineChart.data.datasets[0].data = latSeries;
        lineChart.data.datasets[1].data = lngSeries;
        lineChart.update('none');
      }

      function updatePieChart(authorizedCount, unauthorizedCount) {
        pieChart.data.datasets[0].data = [authorizedCount, unauthorizedCount];
        pieChart.update('none');
      }

      // ======== Event Log ========
      function renderEventLog(rows) {
        // rows: array of { t, lat, lng, statusText, alertText, unauthorized }
        els.eventTableBody.innerHTML = '';
        const frag = document.createDocumentFragment();
        rows.forEach(row => {
          const tr = document.createElement('tr');
          if (row.unauthorized) tr.classList.add('table-danger');
          tr.innerHTML = `
            <td>${row.t}</td>
            <td>${row.lat}</td>
            <td>${row.lng}</td>
            <td>${row.statusText}</td>
            <td>${row.alertText}</td>
          `;
          frag.appendChild(tr);
        });
        els.eventTableBody.appendChild(frag);
      }

      // ======== Data Fetching ========
      async function fetchFeeds(results = 200) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 12000);
        try {
          const res = await fetch(thingspeakFeedsUrl(results), { signal: controller.signal, cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          return json;
        } catch (err) {
          console.warn('Fetch error, using demo data fallback:', err);
          return demoData();
        } finally { clearTimeout(timeout); }
      }

      // ======== Demo Data (fallback when API unreachable) ========
      function demoData() {
        const now = Date.now();
        const feeds = [];
        let baseLat = -26.2041; // Johannesburg
        let baseLng = 28.0473;
        for (let i = 0; i < 30; i++) {
          const t = new Date(now - i * 30000); // 30s apart
          const jitterLat = baseLat + (Math.sin(i/3) * 0.002);
          const jitterLng = baseLng + (Math.cos(i/2) * 0.002);
          const alert = (i % 11 === 0) ? '1' : '0';
          const access = (i % 5 === 0) ? '0' : '1';
          feeds.unshift({
            created_at: t.toISOString(),
            entry_id: i + 1,
            field1: String(jitterLat.toFixed(6)),
            field2: String(jitterLng.toFixed(6)),
            field3: alert,
            field4: access
          });
        }
        return {
          channel: { id: CHANNEL_ID, name: 'Demo Channel' },
          feeds
        };
      }

      // ======== UI Updates from Data ========
      function setConnectionStatus(text, tone = 'secondary') {
        els.connectionStatus.className = `badge text-bg-${tone}`;
        els.connectionStatus.textContent = text;
      }

      function setVehicleOnlineBadge(text, tone = 'secondary') {
        els.vehicleOnlineBadge.className = `badge text-bg-${tone}`;
        els.vehicleOnlineBadge.textContent = text;
      }

      function setAccessStatus(isAuthorized) {
        els.accessStatus.innerHTML = '';
        const icon = document.createElement('i');
        icon.className = `bi ${isAuthorized ? 'bi-check-circle-fill text-green' : 'bi-x-circle-fill text-red'}`;
        const text = document.createElement('span');
        text.textContent = isAuthorized ? 'Authorized' : 'Unauthorized';
        els.accessStatus.append(icon, text);
      }

      function setIntruderPanel(hasAlert, count, lastTs) {
        els.intruderPanel.innerHTML = '';
        const icon = document.createElement('i');
        icon.className = `bi ${hasAlert ? 'bi-exclamation-triangle-fill text-red' : 'bi-bell text-secondary'}`;
        const text = document.createElement('span');
        text.textContent = hasAlert ? 'Intruder Alert!' : 'No alerts detected.';
        els.intruderPanel.append(icon, text);

        if (count > 0) {
          els.alertCountBadge.style.display = '';
          els.alertCountBadge.textContent = `${count} Alert${count === 1 ? '' : 's'}`;
          els.lastAlertTime.style.display = '';
          els.lastAlertTime.textContent = `Last alert: ${formatTimestamp(lastTs)}`;
        } else {
          els.alertCountBadge.style.display = 'none';
          els.lastAlertTime.style.display = 'none';
        }
      }

      function buildEventRows(feeds) {
        const rows = [];
        feeds.forEach(f => {
          const lat = parseNumber(f.field1);
          const lng = parseNumber(f.field2);
          const unauthorizedAlert = String(f.field3 || '0') === '1';
          const authorized = String(f.field4 || '0') === '1';
          rows.push({
            t: formatTimestamp(f.created_at),
            lat: (lat === null ? '—' : lat.toFixed(5)),
            lng: (lng === null ? '—' : lng.toFixed(5)),
            statusText: authorized ? '<span class="text-green">Authorized</span>' : '<span class="text-red">Unauthorized</span>',
            alertText: unauthorizedAlert ? '<span class="text-red">Intruder</span>' : '—',
            unauthorized: !authorized
          });
        });
        return rows;
      }

      // ======== Core Update Cycle ========
      async function updateAll() {
        if (firstLoad) {
          els.mapOverlayText.textContent = 'Loading latest data…';
          els.mapOverlay.style.display = 'flex';
          setConnectionStatus('Connecting…', 'secondary');
        }

        const data = await fetchFeeds(200);
        const feeds = Array.isArray(data?.feeds) ? data.feeds : [];

        if (feeds.length === 0) {
          setConnectionStatus('No data', 'secondary');
          setVehicleOnlineBadge('Vehicle Offline', 'secondary');
          setAccessStatus(false);
          setIntruderPanel(false, 0, null);
          els.lastUpdate.textContent = 'Last update: —';
          els.mapOverlayText.textContent = 'No data available';
          els.mapOverlay.style.display = 'flex';
          return;
        }

        // Latest entry
        const latest = feeds[feeds.length - 1];
        const latestLat = parseNumber(latest.field1);
        const latestLng = parseNumber(latest.field2);
        const latestAuthorized = String(latest.field4 || '0') === '1';
        const latestAlert = String(latest.field3 || '0') === '1';
        const latestTs = latest.created_at;

        // Online/offline
        const mins = minutesSince(latestTs);
        const isOffline = mins > OFFLINE_THRESHOLD_MINUTES;
        setVehicleOnlineBadge(isOffline ? 'Vehicle Offline' : 'Vehicle Online', isOffline ? 'secondary' : 'success');
        setConnectionStatus(isOffline ? `Stale (${Math.floor(mins)}m ago)` : 'Live', isOffline ? 'warning' : 'primary');
        els.lastUpdate.textContent = `Last update: ${formatTimestamp(latestTs)}`;

        // Map
        updateMap(latestLat, latestLng, `Updated: ${formatTimestamp(latestTs)}`);

        // Intruder alerts over last 10 entries
        const recent10 = feeds.slice(-10);
        const recentAlerts = recent10.filter(f => String(f.field3 || '0') === '1');
        const lastAlertTs = recentAlerts.length ? recentAlerts[recentAlerts.length - 1].created_at : null;
        setIntruderPanel(latestAlert, recentAlerts.length, lastAlertTs);

        // Access status
        setAccessStatus(latestAuthorized);

        // Event log last 20 (newest first)
        const last20 = feeds.slice(-20).reverse();
        renderEventLog(buildEventRows(last20));

        // Charts
        const locationPoints = recent10.map(f => ({
          t: f.created_at,
          lat: parseNumber(f.field1),
          lng: parseNumber(f.field2)
        }));
        updateLineChart(locationPoints);

        // Pie: last hour access counts
        const oneHourAgo = Date.now() - 60 * 60000;
        const lastHour = feeds.filter(f => new Date(f.created_at).getTime() >= oneHourAgo);
        const authCount = lastHour.filter(f => String(f.field4 || '0') === '1').length;
        const unauthCount = lastHour.filter(f => String(f.field4 || '0') !== '1').length;
        updatePieChart(authCount, unauthCount);

        if (firstLoad) {
          els.mapOverlay.style.display = 'none';
          firstLoad = false;
        }
      }

      // ======== Init ========
      function init() {
        cacheEls();
        initMap();
        initCharts();

        // First update immediately
        updateAll();

        // Polling
        setInterval(() => {
          updateAll();
        }, API_POLL_INTERVAL_MS);

        // Manual refresh
        els.refreshBtn.addEventListener('click', () => {
          els.refreshBtn.disabled = true;
          const iconHtml = els.refreshBtn.innerHTML;
          els.refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Refreshing';
          updateAll().finally(() => {
            els.refreshBtn.disabled = false;
            els.refreshBtn.innerHTML = iconHtml;
          });
        });
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
  </html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enter Vehicle Location</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0;
               display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { background: white; padding: 40px; border-radius: 10px;
                     box-shadow: 0 0 20px rgba(0,0,0,0.1); width: 400px; text-align: center; }
        h2 { color: #28a745; }
        input { padding: 10px; margin: 10px 0; width: 100%; font-size: 16px; }
        button { padding: 10px 20px; background-color: #28a745; color: white; border: none;
                 font-size: 16px; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #1e7e34; }
    </style>
</head>
<body>
<div class="container">
    <h2>Enter Vehicle Location</h2>
    <input type="text" id="lat" placeholder="Enter Latitude">
    <input type="text" id="lng" placeholder="Enter Longitude">
    <button onclick="redirectToMap()">View on Google Maps</button>
</div>
<script>
    function redirectToMap() {
        var lat = document.getElementById("lat").value;
        var lng = document.getElementById("lng").value;
        if(lat && lng) {
            var url = `https://www.google.com/maps?q=${lat},${lng}`;
            window.open(url, '_blank');
        } else {
            alert("Please enter both latitude and longitude!");
        }
    }
</script>
</body>
</html>
